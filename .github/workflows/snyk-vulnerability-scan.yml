name: Snyk Vulnerability Scan and Issue Creation

on:
  push:
    branches:
      - main  # This will run the workflow on any push to the `main` branch.

jobs:
  security:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout code
      - uses: actions/checkout@v2  # Checkout the code to scan

      # Step 2: Run Snyk to check for vulnerabilities
      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/python@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}  # Ensure your SNYK_TOKEN is set in GitHub secrets
        with:
          command: code test  # Run Snyk test command to scan the code
          args: --sarif-file-output=snyk.sarif  # Save results as SARIF

      # Step 3: Count the number of vulnerabilities found by Snyk
      - name: Count vulnerabilities
        run: |
          length=$(cat snyk.sarif | jq '.runs[0].results | length')
          echo "RESULTS_LENGTH=$length" >> $GITHUB_ENV  # Store result length

      # Step 4: Create a GitHub issue if vulnerabilities are found
      - name: Create GitHub Issue for vulnerabilities
        if: env.RESULTS_LENGTH != '0'  # Only proceed if vulnerabilities are found
        run: |
          issue_body="### Vulnerability Details:\n\n"

          # Loop through all vulnerabilities and extract relevant information
          for i in $(seq 0 $(($RESULTS_LENGTH - 1))); do
            vulnerability_title=$(jq -r ".runs[0].results[$i].message.text" snyk.sarif)
            vulnerability_severity=$(jq -r ".runs[0].results[$i].level" snyk.sarif)
            vulnerability_url=$(jq -r ".runs[0].results[$i].links[0].uri" snyk.sarif)
            vulnerability_location=$(jq -r ".runs[0].results[$i].locations[0].physicalLocation.artifactLocation.uri" snyk.sarif)
            
            issue_body+="**Title**: $vulnerability_title\n"
            issue_body+="**Severity**: $vulnerability_severity\n"
            issue_body+="**Description**: [More details]($vulnerability_url)\n"
            issue_body+="**File/Location**: $vulnerability_location\n\n"
            
            # Additional section for remediation if possible
            issue_body+="### How to Fix:\n[Refer to Snyk's fix or mitigation guide]\n\n"
            issue_body+="### Impact:\n[Explain the potential impact of the vulnerability]\n\n"
            issue_body+="### Action Required:\nPlease review and address this vulnerability.\n\n"
          done

          # Create the issue on GitHub
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -d '{"title":"Snyk Vulnerability Found: '"$vulnerability_severity $vulnerability_title"'","body":"'"$issue_body"'","labels":["vulnerability","bug"]}' \
            https://api.github.com/repos/${{ github.repository }}/issues

      # Step 5: Fail the job if vulnerabilities are found
      - name: Fail job if vulnerabilities found
        run: |
          if [ "$RESULTS_LENGTH" != "0" ]; then
            echo "Job Failed"
            exit 1  # Fail the job if vulnerabilities are found
          else
            echo "Job Passed"  # Pass the job if no vulnerabilities are found
          fi
